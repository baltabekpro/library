<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата кітапты сатып алу</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f4e8;
            color: #3c3c3c;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .payment-container {
            max-width: 500px;
            width: 100%;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            padding: 35px;
            margin: 20px;
            transition: all 0.4s ease;
        }
        
        .payment-container:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.18);
            transform: translateY(-5px);
        }
        
        .header {
            text-align: center;
            padding-bottom: 25px;
            border-bottom: 1px solid #eee;
            margin-bottom: 25px;
        }
        
        .logo {
            font-size: 26px;
            font-weight: bold;
            color: #8c6d46;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo i {
            margin-right: 12px;
            font-size: 30px;
        }
        
        .payment-details {
            margin-bottom: 35px;
        }
        
        .payment-details h3 {
            font-size: 20px;
            margin-bottom: 25px;
            color: #333;
            font-weight: 600;
            position: relative;
            padding-bottom: 12px;
        }
        
        .payment-details h3:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background-color: #8c6d46;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-size: 15px;
        }
        
        .detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .payment-methods {
            margin-bottom: 35px;
        }
        
        .payment-methods h3 {
            font-size: 20px;
            margin-bottom: 25px;
            color: #333;
            font-weight: 600;
            position: relative;
            padding-bottom: 12px;
        }
        
        .payment-methods h3:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background-color: #8c6d46;
        }
        
        .method-option {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .method-option:hover, .method-option.active {
            border-color: #8c6d46;
            background-color: #f9f4e8;
            transform: translateY(-3px);
        }
        
        .method-option.active {
            box-shadow: 0 8px 20px rgba(140, 109, 70, 0.15);
        }
        
        .method-option img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }
        
        .pay-button {
            background-color: #8c6d46;
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .pay-button i {
            margin-right: 10px;
        }
        
        .pay-button:hover {
            background-color: #755a3a;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .pay-button:active {
            transform: translateY(0);
        }
        
        /* Анимация обработки платежа */
        .processing-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.96);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .processing-animation {
            text-align: center;
        }
        
        .processing-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 5px solid #f0f0f0;
            border-top-color: #8c6d46;
            animation: spin 1s infinite linear;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .processing-text {
            font-size: 22px;
            color: #333;
            margin-top: 18px;
            font-weight: 600;
        }
        
        .processing-subtext {
            font-size: 16px;
            color: #666;
            margin-top: 12px;
            max-width: 350px;
            text-align: center;
        }
        
        /* Анимация успешной оплаты */
        .success-animation {
            text-align: center;
        }
        
        .checkmark-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #4bb71b;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px #4bb71b;
            animation: success-circle-fill .4s ease-in-out .4s forwards, success-scale .3s ease-in-out .9s both;
        }
        
        .checkmark {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: #ffffff;
            stroke-miterlimit: 10;
            margin: 20px auto;
            box-shadow: inset 0px 0px 0px #ffffff;
        }
        
        .checkmark-circle-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: success-stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        
        @keyframes success-stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes success-scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        
        @keyframes success-circle-fill {
            100% {
                box-shadow: inset 0px 0px 0px 45px #4bb71b;
            }
        }
        
        /* Прогресс-бар с анимацией */
        .progress {
            height: 12px;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        
        .progress-bar {
            background-color: #8c6d46;
            transition: width 0.5s ease;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
        
        /* Анимация для элементов страницы */
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .method-option, .payment-details, .pay-button {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }
        
        .payment-details {
            animation-delay: 0.2s;
        }
        
        .payment-methods {
            animation-delay: 0.4s;
        }
        
        .method-option:nth-child(1) {
            animation-delay: 0.6s;
        }
        
        .method-option:nth-child(2) {
            animation-delay: 0.8s;
        }
        
        .pay-button {
            animation-delay: 1s;
        }
        
        /* Дополнительные улучшения дизайна */
        .detail-row:hover {
            background-color: rgba(249, 244, 232, 0.5);
            transition: background-color 0.3s ease;
        }
        
        .detail-label {
            position: relative;
            padding-left: 20px;
        }
        
        .detail-label:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background-color: #8c6d46;
            border-radius: 50%;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8c6d46;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4bb71b;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.5s ease;
        }
        
        .notification-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Добавляем оверлей для загрузки -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Добавляем тост для уведомлений -->
    <div class="notification-toast" id="notificationToast">
        <div class="notification-content">Операция успешно выполнена!</div>
    </div>

    <div class="payment-container">
        <div class="header fade-in">
            <div class="logo"><i class="fas fa-book"></i> Кітапхана төлем жүйесі</div>
        </div>
        
        <div class="payment-details">
            <h3>Төлем мәліметтері</h3>
            <div class="detail-row">
                <span class="detail-label">Кітап:</span>
                <span class="detail-value" id="book-title">Жүктелуде...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Бағасы:</span>
                <span class="detail-value" id="book-price">Жүктелуде...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Пайдаланушы:</span>
                <span class="detail-value" id="user-email">Жүктелуде...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Тапсырыс №:</span>
                <span class="detail-value" id="order-id">Жүктелуде...</span>
            </div>
        </div>
        
        <div class="payment-methods">
            <h3>Төлем әдісін таңдаңыз</h3>
            <div class="method-option active" onclick="selectPaymentMethod(this)">
                <div class="d-flex align-items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Банк картасы" class="me-3">
                    <div>
                        <div>Банк картасы</div>
                        <div class="text-muted small">Visa, Mastercard</div>
                    </div>
                </div>
            </div>
            <div class="method-option" onclick="selectPaymentMethod(this)">
                <div class="d-flex align-items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/5968/5968282.png" alt="Kaspi Bank" class="me-3">
                    <div>
                        <div>Kaspi Bank</div>
                        <div class="text-muted small">Kaspi Gold, Red</div>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="pay-button" onclick="processPayment()">
            <i class="fas fa-credit-card"></i> Төлеу
        </button>
    </div>
    
    <!-- Анимация обработки платежа -->
    <div class="processing-container" id="processingAnimation" style="display: none;">
        <div class="processing-animation">
            <div class="processing-circle"></div>
            <div class="processing-text">Төлем өңделуде...</div>
            <div class="processing-subtext">Өтінеміз, төлем жүйесі жауап бергенше күте тұрыңыз</div>
            <div class="progress mt-3" style="width: 300px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>
    
    <!-- Анимация успешной оплаты -->
    <div class="processing-container" id="successAnimation" style="display: none;">
        <div class="processing-animation">
            <div class="success-animation">
                <div class="checkmark-circle">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <path class="checkmark-circle-check" fill="none" d="M14,27 L22,35 L38,19" stroke="white" stroke-width="3"/>
                    </svg>
                </div>
                <div class="processing-text text-success">Төлем сәтті аяқталды!</div>
                <div class="processing-subtext">Рахмет! Сатып алуыңыз расталды. Сіз автоматты түрде кітапхана бетіне бағытталасыз...</div>
            </div>
        </div>
    </div>

    <script>
        // Получение параметров из URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookTitle = urlParams.get('book');
        const bookPrice = urlParams.get('price');
        const userEmail = urlParams.get('user');
        const sessionId = urlParams.get('session');
        
        // Генерация уникального номера заказа
        const orderId = 'ORD-' + Math.floor(Math.random() * 1000000);
        
        // Заполнение данных на странице
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('book-title').textContent = bookTitle || 'Не указано';
            document.getElementById('book-price').textContent = bookPrice ? bookPrice + ' ₸' : 'Не указано';
            document.getElementById('user-email').textContent = userEmail || 'Не указано';
            document.getElementById('order-id').textContent = orderId;
            
            // Проверка наличия всех параметров
            if (bookTitle && bookPrice && userEmail && sessionId) {
                showNotification('Пожалуйста, выберите способ оплаты и нажмите "Төлеу"');
            } else {
                showNotification('Отсутствуют необходимые параметры для оплаты', 'error');
            }
        });
        
        // Выбор метода оплаты
        function selectPaymentMethod(element) {
            // Удаляем класс active у всех методов
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Добавляем класс active выбранному методу
            element.classList.add('active');
            
            // Уведомление о выбранном методе
            const methodName = element.querySelector('div > div:first-child').textContent;
            showNotification(`Выбран метод оплаты: ${methodName}`);
        }
        
        // Имитация процесса оплаты с реалтайм обновлением
        function processPayment() {
            // Показываем анимацию обработки
            document.getElementById('processingAnimation').style.display = 'flex';
            
            // Анимируем прогресс-бар
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            
            const progressInterval = setInterval(() => {
                progress += 2;
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                // При 25% отправляем первое сообщение об обновлении статуса родительскому окну
                if (progress === 25) {
                    updatePaymentStatus('processing_started');
                }
                
                // При 50% отправляем второе сообщение об обновлении статуса
                if (progress === 50) {
                    updatePaymentStatus('processing');
                }
                
                // При 75% отправляем третье сообщение об обновлении статуса
                if (progress === 75) {
                    updatePaymentStatus('verification');
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // После заполнения прогресс-бара показываем анимацию успеха
                    setTimeout(() => {
                        document.getElementById('processingAnimation').style.display = 'none';
                        document.getElementById('successAnimation').style.display = 'flex';
                        
                        // Отправляем сообщение родительскому окну об успешной оплате
                        updatePaymentStatus('completed');
                        
                        // Через 3 секунды закрываем окно или возвращаемся на главную страницу
                        setTimeout(() => {
                            if (window.opener && !window.opener.closed) {
                                window.close(); // Закрываем вкладку, если она была открыта как новая
                            } else {
                                // Возвращаемся на главную с параметром успешной оплаты
                                window.location.href = window.location.origin + '/?payment_success=true&book=' + encodeURIComponent(bookTitle);
                            }
                        }, 3000);
                    }, 500);
                }
            }, 50);
        }
        
        // Функция для отправки обновлений статуса оплаты родительскому окну
        function updatePaymentStatus(status) {
            if (window.opener && !window.opener.closed) {
                try {
                    // Отправляем сообщение родительскому окну
                    window.opener.postMessage({
                        status: status === 'completed' ? 'payment_success' : 'payment_status_update',
                        bookTitle: bookTitle,
                        sessionId: sessionId,
                        statusDetails: status
                    }, window.location.origin);
                    
                    console.log(`Статус оплаты "${status}" отправлен родительскому окну`);
                } catch (e) {
                    console.error('Ошибка при отправке статуса оплаты:', e);
                }
            } else {
                console.log('Родительское окно не найдено или закрыто');
            }
        }
        
        // Функция для показа уведомлений
        function showNotification(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('notificationToast');
            
            // Устанавливаем цвет в зависимости от типа уведомления
            if (type === 'error') {
                toast.style.backgroundColor = '#dc3545';
            } else if (type === 'warning') {
                toast.style.backgroundColor = '#ffc107';
                toast.style.color = '#333';
            } else {
                toast.style.backgroundColor = '#4bb71b';
            }
            
            toast.querySelector('.notification-content').textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Функция для показа/скрытия индикатора загрузки
        function showLoading(show = true) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
